@page "/"
@using Survey.Repositories
@using Survey.Models
@inject NavigationManager Navigation

@rendermode InteractiveServer
@inject ISurveyRepository DbRepository

@if (surveys is null)
{
    <div class="row my-1">
        <div class="col-sm-5 col-lg">
            <RadzenCard>
                <RadzenText Text="Admin Page Loading....." TextStyle="TextStyle.H6"/>
            </RadzenCard>
        </div>
    </div>

    <div class="row my-3">
        <RadzenCard>

            <div class="col-sm-12 col-lg-2">
                    <RadzenStack>
                        <RadzenText TextStyle="TextStyle.H4" Style="color: white; background: black; text-align: center">Title</RadzenText>
                    </RadzenStack>
            </div>
        </RadzenCard>
    </div>
}

else
{
    <div class="row my-3 col-lg">
        <RadzenCard>
            <RadzenText Text="Admin Page" TextStyle="TextStyle.H6"/>
        </RadzenCard>
    </div>
    
    <div class="row my-3">
        <div class="col text-end">
            <RadzenButton Click=@OnClickNewForm Text="NewForm" Size="ButtonSize.Medium" />
        </div>
    </div>

<div class="row my-3">
    <RadzenDataGrid @ref="surveyGrid" FilterPopupRenderMode="PopupRenderMode.OnDemand" AllowPaging="true" PageSize="5"
                    Data="@surveys" TItem="SurveyForm" Count="@surveysCount" LoadData="@LoadSurveys">
        <Columns>
            <RadzenDataGridColumn TItem="SurveyForm" Title="No.">
                <Template Context="survey">
                    @{
                    columIndex++;
                    }
                    @columIndex
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Property="@nameof(SurveyForm.Title)" Title="Title"/>
            <RadzenDataGridColumn Property="@nameof(SurveyForm.CreateTime)" Title="CreateAt"/>
            <RadzenDataGridColumn Property="@nameof(SurveyForm.Constructor)" Title="Manager"/>
            <RadzenDataGridColumn Context="survey" Filterable="false" Sortable="false" TextAlign="TextAlign.Right" Width="156px">
                <Template Context="survey">
                    <NavLink class="btn btn-info" href="@DetailUrl(survey.FormKey)">
                        <i class="bi bi-pencil"></i>
                    </NavLink>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</div>

}

@code
{
    private string statusMessage;

    RadzenDataGrid<SurveyForm> surveyGrid;
    private SurveyForm[]? surveys;
    private int surveysCount;
    private int columIndex = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadSurveys(new LoadDataArgs());
    }

    private async Task LoadSurveys(LoadDataArgs args)
    {
        surveys = (SurveyForm[]?)await DbRepository.GetForms();
        surveysCount = surveys.Length;
        columIndex = 0;
    }
    private string DetailUrl(string key) => $"/form/questioninfo/{key}";


    private void OnClickNewForm()
    {
        Navigation.NavigateTo("/createNew");
    }
}
